---
- name: Prepare Metax API DB servers
  hosts: metaxdbservers
  remote_user: '{{ deployer }}'
  roles:
  - role: fairdata-ansible-postgresql
    vars:
      data_directory: '{{ postgres_data_directory | default("/var/lib/pgsql/9.6/data") }}'
      listen_addresses: '{{ postgres_listen_addresses | default("localhost") }}'
      users:
      - name: '{{ metax_application_database_user | default("metax") }}'
        password: '{{ application_database_password | default("metax") }}'
      databases:
      - name: '{{ metax_application_database | default("metax") }}'
        owner: '{{ metax_application_database_user | default("metax") }}'
      allowed_connections:
      - type: 'host'
        database: '{{ metax_application_database | default("metax") }}'
        user: '{{ metax_application_database_user | default("metax") }}'
        address: '{{ metax_application_database_allowed_subnet | default("127.0.0.1/32") }}'
        method: 'md5'
      - type: 'host'
        database: '{{ metax_application_test_database | default("test-metax") }}'
        user: '{{ metax_application_database_user | default("metax") }}'
        address: '{{ metax_application_database_allowed_subnet | default("127.0.0.1/32") }}'
        method: 'md5'
